---
import { getCollection } from "astro:content";
import { config, locale } from "../../consts";

import { Image } from "astro:assets";

/**
 * Component to get the latest posts from the "blog" collection.
 * Props:
 * - count: number (how many posts to show, default is 3)
 */
const { count = 3 } = Astro.props;

const posts = (await getCollection("blog", ({ data }) => data.draft !== true))
  .sort((a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf())
  .slice(0, count);

const title = "Latest Posts";
const description = "The latest updates from our blog.";

// Tailwind v4: only static class names are safe!
const gridCols =
  count >= 4
    ? "md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4"
    : count === 3
      ? "md:grid-cols-2 lg:grid-cols-3"
      : count === 2
        ? "md:grid-cols-2"
        : "";
---

<section class="mb-8 text-center">
  {title && <h2 class="animate-fade-up mb-2 text-3xl font-bold">{title}</h2>}
  {description && <p class="animate-fade-up mb-8">{description}</p>}
  <div class={`grid gap-6 grid-cols-1 ${gridCols}`}>
    {
      posts.map((post, idx) => (
        <article class="animate-fade-up rounded border p-4 shadow !transition hover:shadow-lg">
          <a href={`${config.base}/blog/${post.id}/`}>
            {post.data.image && (
              <Image
                class="h-48 w-full object-cover"
                src={`${config.base}${post.data.image.src}`}
                alt={post.data.image.alt}
                width={720}
                height={360}
                loading={idx <= 2 ? "eager" : "lazy"}
                sizes="(min-width:1024px) 33vw, (min-width:768px) 50vw, 100vw"
              />
            )}
            <h3 class="mb-2 text-xl font-bold">{post.data.title}</h3>
            <p class="mb-2 text-sm opacity-70">
              <time datetime={post.data.publishDate.toISOString()}>
                {post.data.publishDate.toLocaleDateString(
                  locale.date.locale,
                  locale.date.options,
                )}
              </time>
            </p>
            <p class="mb-2">{post.data.description}</p>
          </a>
        </article>
      ))
    }
  </div>

  <a href={`${config.base}/blog/`} class="btn btn-lg animate-fade-up mt-8"
    >All Posts</a
  >
</section>
